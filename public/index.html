<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat SMR</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Username Prompt Overlay -->
  <div id="username-prompt" class="modal">
    <div class="modal-content">
      <h2>Bienvenido al Chat</h2>
      <p>Escribe tu nombre de usuario:</p>
      <input id="username-input" type="text" placeholder="Usuario" autocomplete="off" autofocus />
      <button id="username-submit">Entrar</button>
    </div>
  </div>

  <!-- Reload Notification -->
  <div id="reload-notification" class="notification hidden">
    <div class="notification-content">
      <p>¡El servidor se ha actualizado!</p>
      <p>La página se recargará en <span id="reload-countdown">5</span> segundos...</p>
      <button id="reload-now">Recargar ahora</button>
    </div>
  </div>

  <!-- Settings Menu -->
  <div id="settings-menu" class="settings-menu hidden">
    <button id="change-username-btn">Cambiar usuario</button>
    <button id="logout-btn">Cerrar sesión</button>
  </div>

  <div id="chat"></div>
  
  <!-- Input container with settings button -->
  <div id="input-container">
    <input id="input" placeholder="Escribe tu mensaje y presiona Enter..." autocomplete="off" disabled />
    <button id="settings-btn" class="settings-button" title="Cambiar usuario">⚙️</button>
  </div>
  <script>
    const ws = new WebSocket(`wss://${location.host}`);
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const usernamePrompt = document.getElementById("username-prompt");
    const usernameInput = document.getElementById("username-input");
    const usernameSubmit = document.getElementById("username-submit");
    const reloadNotification = document.getElementById("reload-notification");
    const reloadCountdown = document.getElementById("reload-countdown");
    const reloadNowBtn = document.getElementById("reload-now");
    const settingsBtn = document.getElementById("settings-btn");
    const settingsMenu = document.getElementById("settings-menu");
    const changeUsernameBtn = document.getElementById("change-username-btn");
    const logoutBtn = document.getElementById("logout-btn");

    let username = "";
    const userColors = {};
    let serverStartTime = null;
    let isAuthenticated = false;
    let pendingUsername = false;
    
    // Generate or retrieve deviceId from localStorage
    let deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = Math.random().toString(36).substring(2) + Date.now().toString(36);
      localStorage.setItem("deviceId", deviceId);
    }

    // Retrieve saved username from localStorage
    let savedUsername = localStorage.getItem("chatUsername");

    function getUserColor(name) {
      if (!userColors[name]) {
        const index = Object.keys(userColors).length % 6;
        userColors[name] = `usercolor${index}`;
      }
      return userColors[name];
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function addMessage(msg, timestamp) {
      let nameMatch = msg.match(/^\[([^\]]+)\]/);
      let content = msg;
      let nameClass = "";
      const timeStr = formatTime(timestamp);
      
      if (nameMatch) {
        const name = nameMatch[1];
        content = msg.replace(/^\[[^\]]+\]/, "");
        nameClass = getUserColor(name);
        chat.innerHTML += `<div class="message"><span class="username ${nameClass}">[${name}]</span><span class="message-content">${content}</span><span class="timestamp">${timeStr}</span></div>`;
      } else {
        chat.innerHTML += `<div class="message"><span class="message-content">${msg}</span><span class="timestamp">${timeStr}</span></div>`;
      }
      chat.scrollTop = chat.scrollHeight;
    }

    // Username prompt handlers
    function submitUsername() {
      const name = usernameInput.value.trim() || "anon";
      const oldUsername = sessionStorage.getItem("oldUsername");
      
      // Send username with old username if it's a username change
      const payload = { type: "username", msg: name, deviceId: deviceId };
      if (oldUsername) {
        payload.oldUsername = oldUsername;
        sessionStorage.removeItem("oldUsername");
      }
      
      ws.send(JSON.stringify(payload));
      username = name;
      pendingUsername = true;
      // Save username to localStorage for auto-join
      localStorage.setItem("chatUsername", name);
      usernamePrompt.classList.add("hidden");
    }

    usernameSubmit.addEventListener("click", submitUsername);
    usernameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        submitUsername();
      }
    });

    // Settings menu handlers
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      settingsMenu.classList.toggle("hidden");
    });

    // Close settings menu when clicking outside
    document.addEventListener("click", (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.add("hidden");
      }
    });

    changeUsernameBtn.addEventListener("click", () => {
      // Store the old username before clearing
      const oldUsername = username || savedUsername;
      
      // Clear saved username
      localStorage.removeItem("chatUsername");
      
      // Store the old username temporarily for the username change
      if (oldUsername) {
        sessionStorage.setItem("oldUsername", oldUsername);
      }
      savedUsername = null;
      
      // Close the connection
      ws.close();
      
      // Reload the page to start fresh
      setTimeout(() => {
        location.reload();
      }, 100);
    });

    logoutBtn.addEventListener("click", () => {
      // Clear saved username
      localStorage.removeItem("chatUsername");
      savedUsername = null;
      
      // Close the connection
      ws.close();
      
      // Reload the page
      setTimeout(() => {
        location.reload();
      }, 100);
    });

    // Reload notification handlers
    function showReloadNotification() {
      reloadNotification.classList.remove("hidden");
      let seconds = 5;
      reloadCountdown.textContent = seconds;
      
      const interval = setInterval(() => {
        seconds--;
        reloadCountdown.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(interval);
          location.reload();
        }
      }, 1000);
      
      reloadNowBtn.addEventListener("click", () => {
        clearInterval(interval);
        location.reload();
      });
    }

    ws.onmessage = (evt) => {
      const data = JSON.parse(evt.data);

      // ---- username prompt ----
      if (data.type === "prompt") {
        // If we have a saved username, auto-join with it
        if (savedUsername && !isAuthenticated) {
          const oldUsername = sessionStorage.getItem("oldUsername");
          const payload = { type: "username", msg: savedUsername, deviceId: deviceId };
          if (oldUsername) {
            payload.oldUsername = oldUsername;
            sessionStorage.removeItem("oldUsername");
          }
          ws.send(JSON.stringify(payload));
          username = savedUsername;
          pendingUsername = true;
        } else if (!isAuthenticated) {
          usernamePrompt.classList.remove("hidden");
          usernameInput.focus();
        }
      }

      // ---- server info ----
      else if (data.type === "serverInfo") {
        serverStartTime = data.startTime;
        // Store in sessionStorage to detect if server restarted
        const lastKnownStart = sessionStorage.getItem("serverStartTime");
        if (lastKnownStart && lastKnownStart !== serverStartTime.toString()) {
          // Server restarted! Show reload notification
          showReloadNotification();
        }
        sessionStorage.setItem("serverStartTime", serverStartTime.toString());
      }

      // ---- chat history ----
      else if (data.type === "history") {
        data.messages.forEach((msgData) => {
          addMessage(msgData.msg, msgData.timestamp);
        });
        // History is sent after username is accepted, so enable input now
        if (pendingUsername || !isAuthenticated) {
          isAuthenticated = true;
          pendingUsername = false;
          input.disabled = false;
          input.focus();
        }
      }

      // ---- server reload ----
      else if (data.type === "reload") {
        showReloadNotification();
      }

      // ---- regular chat message ----
      else if (data.type === "chat") {
        addMessage(data.msg, data.timestamp || Date.now());
        // If we receive a chat message and we're pending authentication, enable input
        if (pendingUsername || !isAuthenticated) {
          isAuthenticated = true;
          pendingUsername = false;
          input.disabled = false;
          input.focus();
        }
      }
    };

    // ---- send message ----
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && input.value.trim()) {
        if (!isAuthenticated) {
          console.log("Not authenticated yet, cannot send message");
          return;
        }
        ws.send(JSON.stringify({ type: "chat", msg: input.value }));
        input.value = "";
      }
    });

    // Periodic server version check (every 30 seconds)
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN && serverStartTime) {
        ws.send(JSON.stringify({ type: "ping" }));
      }
    }, 30000);
  </script>
</body>
</html>
