<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Chat SMR</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Username Prompt Overlay -->
    <div id="username-prompt" class="modal hidden">
      <div class="modal-content">
        <h2>Bienvenido al Chat</h2>
        <p>Escribe tu nombre de usuario:</p>
        <input
          id="username-input"
          type="text"
          placeholder="Usuario"
          autocomplete="off"
          autofocus
        />
        <button id="username-submit">Entrar</button>
      </div>
    </div>

    <!-- Reload Notification -->
    <div id="reload-notification" class="notification hidden">
      <div class="notification-content">
        <p>¡El servidor se ha actualizado!</p>
        <p>
          La página se recargará en
          <span id="reload-countdown">5</span> segundos...
        </p>
        <button id="reload-now">Recargar ahora</button>
      </div>
    </div>

    <!-- Settings Menu -->
    <div id="settings-menu" class="settings-menu hidden">
      <button id="change-username-btn">Cambiar usuario</button>
      <button id="logout-btn">Cerrar sesión</button>
    </div>

    <div id="chat"></div>

    <!-- Input container with settings button -->
    <div id="input-container">
      <input
        id="input"
        placeholder="Escribe tu mensaje y presiona Enter..."
        autocomplete="off"
        disabled
      />
      <button id="settings-btn" class="settings-button" title="Configuración">
        ⚙️
      </button>
    </div>

    <script>
      const WEBSOCKET_SERVER = "wss://chat-cp1p.onrender.com";

      // Elements
      const chat = document.getElementById("chat");
      const input = document.getElementById("input");
      const usernamePrompt = document.getElementById("username-prompt");
      const usernameInput = document.getElementById("username-input");
      const usernameSubmit = document.getElementById("username-submit");
      const reloadNotification = document.getElementById("reload-notification");
      const reloadCountdown = document.getElementById("reload-countdown");
      const reloadNowBtn = document.getElementById("reload-now");
      const settingsBtn = document.getElementById("settings-btn");
      const settingsMenu = document.getElementById("settings-menu");
      const changeUsernameBtn = document.getElementById("change-username-btn");
      const logoutBtn = document.getElementById("logout-btn");

      // State
      let ws = null;
      let username = "";
      let isAuthenticated = false;
      let serverStartTime = null;
      let reconnectAttempt = 0;
      let reconnectTimer = null;
      const userColors = {};

      // Device ID - persistent across sessions
      let deviceId = localStorage.getItem("deviceId");
      if (!deviceId) {
        deviceId = `${Math.random().toString(36).substr(2, 9)}-${Date.now()}`;
        localStorage.setItem("deviceId", deviceId);
        console.log("Generated deviceId:", deviceId);
      }

      // --- HELPER FUNCTIONS ---

      function getUserColor(name) {
        if (!userColors[name]) {
          const index = Object.keys(userColors).length % 6;
          userColors[name] = `usercolor${index}`;
        }
        return userColors[name];
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function addMessage(msg, timestamp) {
        const timeStr = formatTime(timestamp);

        // Parse username from message
        const nameMatch = msg.match(/^\[([^\]]+)\]/);

        if (nameMatch) {
          const name = nameMatch[1];
          const content = msg.substring(nameMatch[0].length).trim();
          const colorClass = getUserColor(name);

          chat.innerHTML += `<div class="message">
        <span class="username ${colorClass}">[${escapeHtml(name)}]</span>
        <span class="message-content">${escapeHtml(content)}</span>
        <span class="timestamp">${timeStr}</span>
      </div>`;
        } else {
          // System message
          chat.innerHTML += `<div class="message">
        <span class="message-content">${escapeHtml(msg)}</span>
        <span class="timestamp">${timeStr}</span>
      </div>`;
        }

        chat.scrollTop = chat.scrollHeight;
      }

      function showReloadNotification() {
        reloadNotification.classList.remove("hidden");
        let seconds = 5;
        reloadCountdown.textContent = seconds;

        const interval = setInterval(() => {
          seconds--;
          reloadCountdown.textContent = seconds;
          if (seconds <= 0) {
            clearInterval(interval);
            location.reload();
          }
        }, 1000);

        reloadNowBtn.onclick = () => {
          clearInterval(interval);
          location.reload();
        };
      }

      // --- WEBSOCKET CONNECTION ---

      function connect() {
        if (ws && ws.readyState === WebSocket.OPEN) return;

        console.log("Connecting to:", WEBSOCKET_SERVER);
        ws = new WebSocket(WEBSOCKET_SERVER);

        ws.onopen = () => {
          console.log("✓ Connected");

          const savedUsername = localStorage.getItem("chatUsername");
          const isReconnect = reconnectAttempt > 0;

          if (savedUsername) {
            // Auto-login with saved username
            authenticate(savedUsername, isReconnect);
          } else {
            // Show username prompt for new users
            usernamePrompt.classList.remove("hidden");
            usernameInput.focus();
          }

          reconnectAttempt = 0;
        };

        ws.onmessage = (evt) => {
          const data = JSON.parse(evt.data);

          switch (data.type) {
            case "serverInfo":
              handleServerInfo(data);
              break;

            case "authenticated":
              handleAuthenticated(data);
              break;

            case "history":
              data.messages.forEach((m) => addMessage(m.msg, m.timestamp));
              break;

            case "chat":
              addMessage(data.msg, data.timestamp);
              break;

            case "usernameChanged":
              // Transfer color
              if (userColors[data.oldUsername]) {
                userColors[data.username] = userColors[data.oldUsername];
              }
              username = data.username;
              localStorage.setItem("chatUsername", username);
              break;

            case "pong":
              if (data.serverStartTime !== serverStartTime) {
                showReloadNotification();
              }
              break;

            case "error":
              console.error("Server error:", data.msg);
              addMessage(`❌ Error: ${data.msg}`, Date.now());
              break;

            case "replaced":
              console.log("Connection replaced");
              break;
          }
        };

        ws.onclose = () => {
          console.log("✗ Disconnected");
          isAuthenticated = false;
          input.disabled = true;

          if (!reconnectTimer) {
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempt), 30000);
            reconnectAttempt++;

            addMessage(
              `Desconectado. Reconectando en ${Math.round(delay / 1000)}s...`,
              Date.now()
            );

            reconnectTimer = setTimeout(() => {
              reconnectTimer = null;
              connect();
            }, delay);
          }
        };

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
        };
      }

      function authenticate(name, isReconnect = false) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "auth",
              username: name,
              deviceId: deviceId,
              isReconnect: isReconnect,
            })
          );
        }
      }

      function handleServerInfo(data) {
        const newStartTime = data.startTime;
        const savedStartTime = localStorage.getItem("serverStartTime");

        if (
          savedStartTime &&
          savedStartTime !== newStartTime.toString() &&
          serverStartTime
        ) {
          showReloadNotification();
        }

        serverStartTime = newStartTime;
        localStorage.setItem("serverStartTime", newStartTime.toString());
      }

      function handleAuthenticated(data) {
        console.log("✓ Authenticated as:", data.username);
        username = data.username;
        isAuthenticated = true;
        input.disabled = false;
        input.focus();

        usernamePrompt.classList.add("hidden");

        localStorage.setItem("chatUsername", username);

        if (data.serverStartTime) {
          handleServerInfo({ startTime: data.serverStartTime });
        }
      }

      // --- UI EVENT HANDLERS ---

      usernameSubmit.addEventListener("click", () => {
        const name = usernameInput.value.trim() || "anon";
        authenticate(name, false);
        usernamePrompt.classList.add("hidden");
      });

      usernameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          usernameSubmit.click();
        }
      });

      settingsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
          settingsMenu.classList.add("hidden");
        }
      });

      changeUsernameBtn.addEventListener("click", () => {
        const newName = prompt("Nuevo nombre de usuario:", username);
        if (
          newName &&
          newName.trim() &&
          ws &&
          ws.readyState === WebSocket.OPEN
        ) {
          ws.send(
            JSON.stringify({
              type: "changeUsername",
              newUsername: newName.trim(),
            })
          );
        }
        settingsMenu.classList.add("hidden");
      });

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("chatUsername");
        localStorage.removeItem("serverStartTime");
        if (ws) ws.close();
        location.reload();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && input.value.trim()) {
          if (isAuthenticated && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "chat",
                msg: input.value,
              })
            );
            input.value = "";
          }
        }
      });

      // Periodic ping
      setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN && serverStartTime) {
          ws.send(JSON.stringify({ type: "ping" }));
        }
      }, 30000);

      // Start
      connect();
    </script>
  </body>
</html>
