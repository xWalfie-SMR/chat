<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat SMR</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Username Prompt Overlay -->
  <div id="username-prompt" class="modal">
    <div class="modal-content">
      <h2>Bienvenido al Chat</h2>
      <p>Escribe tu nombre de usuario:</p>
      <input id="username-input" type="text" placeholder="Usuario" autocomplete="off" autofocus />
      <button id="username-submit">Entrar</button>
    </div>
  </div>

  <!-- Reload Notification -->
  <div id="reload-notification" class="notification hidden">
    <div class="notification-content">
      <p>¡El servidor se ha actualizado!</p>
      <p>La página se recargará en <span id="reload-countdown">5</span> segundos...</p>
      <button id="reload-now">Recargar ahora</button>
    </div>
  </div>

  <!-- Settings Menu -->
  <div id="settings-menu" class="settings-menu hidden">
    <button id="change-username-btn">Cambiar usuario</button>
    <button id="logout-btn">Cerrar sesión</button>
  </div>

  <div id="chat"></div>

  <!-- Input container with settings button -->
  <div id="input-container">
    <input id="input" placeholder="Escribe tu mensaje y presiona Enter..." autocomplete="off" disabled />
    <button id="settings-btn" class="settings-button" title="Cambiar usuario">⚙️</button>
  </div>
  <script>
    // HARDCODED WebSocket server URL - DO NOT CHANGE
    const WEBSOCKET_SERVER = 'wss://chat-cp1p.onrender.com';
    
    console.log('=== CHAT CLIENT STARTING ===');
    console.log('Connecting to WebSocket server:', WEBSOCKET_SERVER);
    
    const ws = new WebSocket(WEBSOCKET_SERVER);
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const usernamePrompt = document.getElementById("username-prompt");
    const usernameInput = document.getElementById("username-input");
    const usernameSubmit = document.getElementById("username-submit");
    const reloadNotification = document.getElementById("reload-notification");
    const reloadCountdown = document.getElementById("reload-countdown");
    const reloadNowBtn = document.getElementById("reload-now");
    const settingsBtn = document.getElementById("settings-btn");
    const settingsMenu = document.getElementById("settings-menu");
    const changeUsernameBtn = document.getElementById("change-username-btn");
    const logoutBtn = document.getElementById("logout-btn");

    let username = "";
    let isAuthenticated = false;
    let serverStartTime = null;
    let connectionReady = false;
    const userColors = {};

    // Generate or retrieve deviceId
    let deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = Math.random().toString(36).substring(2) + Date.now().toString(36);
      localStorage.setItem("deviceId", deviceId);
      console.log('Generated new deviceId:', deviceId);
    } else {
      console.log('Using existing deviceId:', deviceId);
    }

    // Retrieve saved username
    const savedUsername = localStorage.getItem("chatUsername");
    console.log('Saved username:', savedUsername || 'none');

    function getUserColor(name) {
      if (!userColors[name]) {
        const index = Object.keys(userColors).length % 6;
        userColors[name] = `usercolor${index}`;
      }
      return userColors[name];
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function addMessage(msg, timestamp) {
      const nameMatch = msg.match(/^\[([^\]]+)\]/);
      let content = msg;
      let nameClass = "";
      const timeStr = formatTime(timestamp);

      if (nameMatch) {
        const name = nameMatch[1];
        content = msg.replace(/^\[[^\]]+\]/, "");
        nameClass = getUserColor(name);
        chat.innerHTML += `<div class="message"><span class="username ${nameClass}">[${name}]</span><span class="message-content">${escapeHtml(content)}</span><span class="timestamp">${timeStr}</span></div>`;
      } else {
        chat.innerHTML += `<div class="message"><span class="message-content">${escapeHtml(msg)}</span><span class="timestamp">${timeStr}</span></div>`;
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Submit username
    function submitUsername() {
      if (!connectionReady) {
        console.log('Connection not ready yet');
        addMessage('Esperando conexión al servidor...', Date.now());
        return;
      }

      const name = usernameInput.value.trim();
      const oldUsername = sessionStorage.getItem("oldUsername");

      const payload = { type: "username", msg: name || "anon", deviceId: deviceId };
      if (oldUsername) {
        payload.oldUsername = oldUsername;
        sessionStorage.removeItem("oldUsername");
      }

      console.log('Sending username:', payload);
      ws.send(JSON.stringify(payload));
      usernamePrompt.classList.add("hidden");
    }

    usernameSubmit.addEventListener("click", submitUsername);
    usernameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitUsername();
    });

    // Settings menu
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      settingsMenu.classList.toggle("hidden");
    });

    document.addEventListener("click", (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.add("hidden");
      }
    });

    changeUsernameBtn.addEventListener("click", () => {
      if (username) {
        sessionStorage.setItem("oldUsername", username);
      }
      isAuthenticated = false;
      username = "";
      input.disabled = true;
      usernamePrompt.classList.remove("hidden");
      usernameInput.value = "";
      usernameInput.focus();
      settingsMenu.classList.add("hidden");
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("chatUsername");
      ws.close();
      setTimeout(() => location.reload(), 100);
    });

    // Reload notification
    function showReloadNotification() {
      reloadNotification.classList.remove("hidden");
      let seconds = 5;
      reloadCountdown.textContent = seconds;

      const interval = setInterval(() => {
        seconds--;
        reloadCountdown.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(interval);
          location.reload();
        }
      }, 1000);

      reloadNowBtn.onclick = () => {
        clearInterval(interval);
        location.reload();
      };
    }

    // WebSocket open handler
    ws.onopen = () => {
      console.log("✓ Connected to server successfully");
      connectionReady = true;
      addMessage('Conectado al servidor.', Date.now());
    };

    // WebSocket message handling
    ws.onmessage = (evt) => {
      console.log('← Received:', evt.data);
      const data = JSON.parse(evt.data);

      if (data.type === "prompt") {
        console.log('Received prompt, saved username:', savedUsername);
        // Auto-join with saved username if available
        if (savedUsername && !isAuthenticated) {
          const oldUsername = sessionStorage.getItem("oldUsername");
          const payload = { type: "username", msg: savedUsername, deviceId: deviceId };
          if (oldUsername) {
            payload.oldUsername = oldUsername;
            sessionStorage.removeItem("oldUsername");
          }
          console.log('→ Auto-sending username:', payload);
          ws.send(JSON.stringify(payload));
        } else if (!isAuthenticated) {
          usernamePrompt.classList.remove("hidden");
          usernameInput.focus();
        }
      }

      else if (data.type === "serverInfo") {
        const newStartTime = data.startTime;
        const lastKnownStart = sessionStorage.getItem("serverStartTime");
        
        if (lastKnownStart && lastKnownStart !== newStartTime.toString()) {
          showReloadNotification();
        }
        sessionStorage.setItem("serverStartTime", newStartTime.toString());
        serverStartTime = newStartTime;
      }

      else if (data.type === "authenticated") {
        // Server confirmed authentication
        console.log('✓ Authenticated as:', data.username);
        username = data.username;
        isAuthenticated = true;
        input.disabled = false;
        input.focus();
        localStorage.setItem("chatUsername", username);
      }

      else if (data.type === "history") {
        // Load chat history
        console.log('Loading history:', data.messages.length, 'messages');
        data.messages.forEach((msgData) => {
          addMessage(msgData.msg, msgData.timestamp);
        });
      }

      else if (data.type === "reload") {
        showReloadNotification();
      }

      else if (data.type === "chat") {
        addMessage(data.msg, data.timestamp || Date.now());
      }

      else if (data.type === "error") {
        console.error("Server error:", data.msg);
        addMessage(`Error: ${data.msg}`, Date.now());
      }
    };

    ws.onclose = () => {
      console.log("✗ Disconnected from server");
      connectionReady = false;
      addMessage("Desconectado del servidor. Recarga la página para reconectar.", Date.now());
      input.disabled = true;
    };

    ws.onerror = (err) => {
      console.error("✗ WebSocket error:", err);
      addMessage("Error de conexión. Verifica que el servidor esté activo.", Date.now());
    };

    // Send message
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && input.value.trim()) {
        if (!isAuthenticated) {
          console.log("Not authenticated yet");
          return;
        }
        const msg = input.value;
        console.log('→ Sending message:', msg);
        ws.send(JSON.stringify({ type: "chat", msg: msg }));
        input.value = "";
      }
    });

    // Periodic version check
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN && serverStartTime) {
        ws.send(JSON.stringify({ type: "ping" }));
      }
    }, 30000);
  </script>
</body>
</html>