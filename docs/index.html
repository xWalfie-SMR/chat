<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat SMR</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Username Prompt Overlay -->
  <div id="username-prompt" class="modal hidden">
    <div class="modal-content">
      <h2>Bienvenido al Chat</h2>
      <p>Escribe tu nombre de usuario:</p>
      <input id="username-input" type="text" placeholder="Usuario (sin espacios)" autocomplete="off" autofocus />
      <button id="username-submit">Entrar</button>
      <p id="username-error" class="error-text hidden">Los nombres no pueden contener espacios</p>
    </div>
  </div>

  <!-- Login Success Notification -->
  <div id="login-notification" class="notification notification-success hidden">
    <div class="notification-content">
      <p>✓ Conectado como <span id="login-username"></span></p>
    </div>
  </div>

  <!-- Reload Notification -->
  <div id="reload-notification" class="notification hidden">
    <div class="notification-content">
      <p>¡El servidor se ha actualizado!</p>
      <p>La página se recargará en <span id="reload-countdown">5</span> segundos...</p>
      <button id="reload-now">Recargar ahora</button>
    </div>
  </div>

  <!-- Settings Menu -->
  <div id="settings-menu" class="settings-menu hidden">
    <button id="change-username-btn">Cambiar usuario</button>
    <button id="logout-btn">Cerrar sesión</button>
  </div>

  <div id="chat"></div>

  <!-- Input container with settings button -->
  <div id="input-container">
    <input id="input" placeholder="Escribe tu mensaje y presiona Enter..." autocomplete="off" disabled />
    <button id="settings-btn" class="settings-button" title="Configuración">⚙️</button>
  </div>

  <script>
    // HARDCODED WebSocket server URL
    const WEBSOCKET_SERVER = 'wss://chat-cp1p.onrender.com';
    
    console.log('=== CHAT CLIENT STARTING ===');
    
    // Elements
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const usernamePrompt = document.getElementById("username-prompt");
    const usernameInput = document.getElementById("username-input");
    const usernameSubmit = document.getElementById("username-submit");
    const usernameError = document.getElementById("username-error");
    const loginNotification = document.getElementById("login-notification");
    const loginUsername = document.getElementById("login-username");
    const reloadNotification = document.getElementById("reload-notification");
    const reloadCountdown = document.getElementById("reload-countdown");
    const reloadNowBtn = document.getElementById("reload-now");
    const settingsBtn = document.getElementById("settings-btn");
    const settingsMenu = document.getElementById("settings-menu");
    const changeUsernameBtn = document.getElementById("change-username-btn");
    const logoutBtn = document.getElementById("logout-btn");

    // State
    let ws = null;
    let username = "";
    let myColor = "";
    let isAuthenticated = false;
    let serverStartTime = null;
    let reconnectAttempt = 0;
    let reconnectTimer = null;
    let isChangingUsername = false;
    let isLoggingOut = false;
    let isKicked = false;
    const userColors = {};

    // Generate or retrieve deviceId
    let deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = Math.random().toString(36).substring(2) + Date.now().toString(36);
      localStorage.setItem("deviceId", deviceId);
      console.log('Generated new deviceId:', deviceId);
    }

    // Helper functions
    function validateUsername(name) {
      return name && !name.includes(' ') && name.length <= 20;
    }

    function getUserColor(name) {
      return userColors[name] || 'usercolor0';
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addMessage(msg, timestamp, colors) {
      // Update color mappings if provided
      if (colors) {
        Object.assign(userColors, colors);
      }

      const nameMatch = msg.match(/^\[([^\]]+)\]/);
      let content = msg;
      let nameClass = "";
      const timeStr = formatTime(timestamp);

      if (nameMatch) {
        const name = nameMatch[1];
        content = msg.replace(/^\[[^\]]+\]/, "");
        
        // Special styling for ADMIN messages
        if (name === "ADMIN") {
          nameClass = "admin-message";
        } else {
          nameClass = getUserColor(name);
        }
        
        chat.innerHTML += `<div class="message"><span class="username ${nameClass}">[${name}]</span><span class="message-content">${escapeHtml(content)}</span><span class="timestamp">${timeStr}</span></div>`;
      } else {
        chat.innerHTML += `<div class="message"><span class="message-content">${escapeHtml(msg)}</span><span class="timestamp">${timeStr}</span></div>`;
      }
      chat.scrollTop = chat.scrollHeight;
    }

    // Login success notification
    function showLoginNotification(username) {
      loginUsername.textContent = username;
      loginNotification.classList.remove("hidden");
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        loginNotification.classList.add("hidden");
      }, 3000);
    }

    // Reload notification
    function showReloadNotification() {
      reloadNotification.classList.remove("hidden");
      let seconds = 5;
      reloadCountdown.textContent = seconds;

      const interval = setInterval(() => {
        seconds--;
        reloadCountdown.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(interval);
          location.reload();
        }
      }, 1000);

      reloadNowBtn.onclick = () => {
        clearInterval(interval);
        location.reload();
      };
    }

    // WebSocket connection management
    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      if (isKicked) {
        console.log("Cannot reconnect - user was kicked");
        return;
      }

      console.log('Connecting to:', WEBSOCKET_SERVER);
      ws = new WebSocket(WEBSOCKET_SERVER);

      ws.onopen = () => {
        console.log("✓ Connected to server");
        
        // Get saved username
        const savedUsername = localStorage.getItem("chatUsername");
        
        if (savedUsername && !isChangingUsername && !isLoggingOut) {
          // Auto-authenticate with saved username
          console.log('Auto-authenticating with saved username:', savedUsername);
          ws.send(JSON.stringify({ 
            type: "auth", 
            username: savedUsername, 
            deviceId: deviceId,
            isReconnect: reconnectAttempt > 0
          }));
        } else if (!isAuthenticated && !isLoggingOut) {
          // Show username prompt
          usernamePrompt.classList.remove("hidden");
          usernameInput.focus();
        }

        if (reconnectAttempt > 0) {
          addMessage("✓ Reconectado al servidor", Date.now());
        }
        reconnectAttempt = 0;
      };

      ws.onmessage = (evt) => {
        const data = JSON.parse(evt.data);
        console.log('← Received:', data.type, data);

        switch(data.type) {
          case "serverInfo":
            handleServerInfo(data);
            break;

          case "authenticated":
            handleAuthenticated(data);
            break;

          case "history":
            handleHistory(data);
            break;

          case "chat":
            addMessage(data.msg, data.timestamp || Date.now(), data.colors);
            break;

          case "usernameChanged":
            handleUsernameChanged(data);
            break;

          case "kicked":
            handleKicked(data);
            break;

          case "invalidUsername":
            usernameError.classList.remove("hidden");
            setTimeout(() => {
              usernameError.classList.add("hidden");
            }, 3000);
            break;

          case "pong":
            handlePong(data);
            break;

          case "replaced":
            console.log("Connection replaced by new device");
            break;

          case "error":
            console.error("Server error:", data.msg);
            addMessage(`Error: ${data.msg}`, Date.now());
            break;
        }
      };

      ws.onclose = () => {
        console.log("✗ Disconnected from server");
        isAuthenticated = false;
        input.disabled = true;
        
        // Don't auto-reconnect if logging out or kicked
        if (isLoggingOut || isKicked) {
          isLoggingOut = false;
          return;
        }

        // Auto-reconnect
        if (!reconnectTimer) {
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempt), 30000);
          reconnectAttempt++;
          console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempt})`);
          addMessage(`Desconectado. Reconectando...`, Date.now());
          
          reconnectTimer = setTimeout(() => {
            reconnectTimer = null;
            connect();
          }, delay);
        }
      };

      ws.onerror = (err) => {
        console.error("✗ WebSocket error:", err);
      };
    }

    function handleServerInfo(data) {
      const newStartTime = data.startTime;
      const savedStartTime = localStorage.getItem("serverStartTime");
      
      // Check if server has restarted
      if (savedStartTime && savedStartTime !== newStartTime.toString() && serverStartTime) {
        console.log("Server restart detected!");
        showReloadNotification();
      }
      
      serverStartTime = newStartTime;
      localStorage.setItem("serverStartTime", newStartTime.toString());
    }

    function handleAuthenticated(data) {
      console.log('✓ Authenticated as:', data.username, 'color:', data.color);
      username = data.username;
      myColor = data.color;
      
      // Store my color in the mapping
      if (data.color) {
        userColors[username] = data.color;
      }
      
      isAuthenticated = true;
      isChangingUsername = false;
      input.disabled = false;
      input.focus();
      
      // Hide username prompt if visible
      usernamePrompt.classList.add("hidden");
      
      // Show login notification
      showLoginNotification(username);
      
      // Save username if not anonymous
      if (!username.toLowerCase().startsWith('anon')) {
        localStorage.setItem("chatUsername", username);
      }
      
      // Update server start time if provided
      if (data.serverStartTime) {
        handleServerInfo({ startTime: data.serverStartTime });
      }
    }

    function handleHistory(data) {
      console.log('Loading history:', data.messages.length, 'messages');
      
      // Load color mappings first
      if (data.colors) {
        Object.assign(userColors, data.colors);
      }
      
      // Then load messages
      data.messages.forEach((msgData) => {
        addMessage(msgData.msg, msgData.timestamp, msgData.colors);
      });
    }

    function handleUsernameChanged(data) {
      console.log('Username changed from', data.oldUsername, 'to', data.username);
      
      // Keep the same color!
      if (data.color) {
        userColors[data.username] = data.color;
        // Remove old username color mapping
        delete userColors[data.oldUsername];
      }
      
      username = data.username;
      myColor = data.color;
      isChangingUsername = false;
      
      // Save new username
      if (!username.toLowerCase().startsWith('anon')) {
        localStorage.setItem("chatUsername", username);
      }
      
      // Show notification
      showLoginNotification(username);
    }

    function handleKicked(data) {
      isKicked = true;
      localStorage.removeItem("chatUsername");
      addMessage(`⚠️ ${data.reason}`, Date.now());
      
      // Close connection
      if (ws) {
        ws.close();
      }
      
      // Show reload prompt after 3 seconds
      setTimeout(() => {
        if (confirm("Has sido expulsado del chat. ¿Deseas recargar la página?")) {
          location.reload();
        }
      }, 3000);
    }

    function handlePong(data) {
      if (data.serverStartTime && serverStartTime && data.serverStartTime !== serverStartTime) {
        console.log("Server restart detected via ping!");
        showReloadNotification();
      }
    }

    // UI Event Handlers
    function submitUsername() {
      const name = usernameInput.value.trim();
      
      // Validate username
      if (name && !validateUsername(name)) {
        usernameError.classList.remove("hidden");
        setTimeout(() => {
          usernameError.classList.add("hidden");
        }, 3000);
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.log('WebSocket not ready');
        return;
      }

      ws.send(JSON.stringify({ 
        type: "auth", 
        username: name || "anon", 
        deviceId: deviceId,
        isReconnect: false
      }));
      
      usernamePrompt.classList.add("hidden");
    }

    usernameSubmit.addEventListener("click", submitUsername);
    usernameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitUsername();
    });

    // Validate username as user types
    usernameInput.addEventListener("input", (e) => {
      if (e.target.value.includes(' ')) {
        usernameError.classList.remove("hidden");
      } else {
        usernameError.classList.add("hidden");
      }
    });

    // Settings menu
    settingsBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      settingsMenu.classList.toggle("hidden");
    });

    document.addEventListener("click", (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.add("hidden");
      }
    });

    changeUsernameBtn.addEventListener("click", () => {
      let newName = prompt("Ingresa tu nuevo nombre de usuario (sin espacios):", username);
      
      if (newName) {
        newName = newName.trim();
        if (!validateUsername(newName)) {
          alert("Nombre inválido. No se permiten espacios y máximo 20 caracteres.");
          return;
        }
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          isChangingUsername = true;
          ws.send(JSON.stringify({ 
            type: "changeUsername", 
            newUsername: newName
          }));
        }
      }
      settingsMenu.classList.add("hidden");
    });

    logoutBtn.addEventListener("click", () => {
      isLoggingOut = true;
      localStorage.removeItem("chatUsername");
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "logout" }));
      }
      if (ws) ws.close();
      setTimeout(() => location.reload(), 100);
    });

    // Send message
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && input.value.trim()) {
        if (!isAuthenticated || !ws || ws.readyState !== WebSocket.OPEN) {
          console.log("Not ready to send");
          return;
        }
        
        const msg = input.value;
        ws.send(JSON.stringify({ type: "chat", msg: msg }));
        input.value = "";
      }
    });

    // Periodic ping to check server status
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN && serverStartTime) {
        ws.send(JSON.stringify({ type: "ping" }));
      }
    }, 30000);

    // Start connection
    connect();
  </script>
</body>
</html>